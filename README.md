# Smart-LED-lamp-Arduino

Описание:
---------------------
В коде реализована работа лампы, которая поворачивается при включении и имеет регулировку уровня света через приближение или отдаление ладони.

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/87d68145-9096-4818-ab6f-692e27a64130)

Принцип работы:
---------------------
За основу взят корпус от сломанной люминисцентной лампы. Свет заменен на 5 светодиодов. Добавлен сервопривод для автоматического разворота, потенциометр для регулирования угла поворота, ультразвуковой датчик для управления включением лампы и силой свечения.
В плафон лампы установлен дальномер, который реагирует только в диапазоне от 0 до 20 см:

  0-3 см - светодиоды выключены, лампа разворачивается в стартовую позицию.
  
  4-20 см - лампа поворачивается в рабочую позицию, интенсивность свечения настраивается от дальности ладони, где 4 см - минимальная яркость, 20 см - максимальная яркость.

Чтобы настроить угол поворота лампы, добавлен потенциометр. Настройка осуществляется только один раз, или меняется при необходимости. Дальше лампа всегда будет выходить на заданную позицию.

Потребуется:
---------------------
1. Каркас лампы
2. Подшипник
3. Контролер Arduino Nano
4. Сервопривод SG90
5. Ультразвуковой датчик HC-SR04
6. Потенциометр (можно без него, указав градус поворота в Скетче)
7. Провода: красный - 150, черный - 150, зеленый (для сервопривода) - 100, обрезки от 5 до 10 см ~ 10 шт
8. Резисторы - 5 шт. 220 Ом
9. Светодиод 3мм - 5 шт.
10. Разъем USP Type-A (male) или источник питания ~5V

Реализация:
---------------------
1. Разметка проводов.

Из лампы убираем все "лишнее". В своем варианте я укоротил плафон светильника, вырезал дополнительные отверстия под провода, ультразвуковой датчик и потенциометр.
Заготавливаем провода для пайки. Так как Arduino Nano хорошо помещается в боксе, где был патрон от люминисцентной лампы, оптимальное расположение проводов:
![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/eecf114a-ac4b-44aa-a295-c024c7a7969f)

2. Пайка плафона.

Рекомендую потратить время и крепко закрепить Arduino Nano на своем месте. Убедитесь, что Вам будет удобно подключать usb-кабель для кодирования. Я этого не сделал и для загрузки обновления приходилось каждый раз разбирать плафон.
Пайку осуществляем по схеме ниже. В плафон пойдет всё, кроме сервопривода. 

LifeHack: гибкие провода можно взять из интернет-кабеля, там их 8 штук, да и стоит такой провод дешевле.

По итогу у нас должен быть готовый плафон и от него выходит 3 длинных провода (плюс, общий минус, pin для серво).

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/f71b8976-3f9b-4d10-881b-5d3098f00f66)

У меня получилось так:
![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/430a4367-ed91-4b3c-9d8c-33de54da3c4e)

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/cf50ccb5-af00-4717-a0ff-67f8673dfbd4)


Теперь 3 длинных провода (плюс, общий минус, pin для серво) можно пропустить по корпусу. На сгибах оставляйте запас по 3 см кабеля, тогда лампу можно будет сгибать без риска обрыва проводов.

3. Установка сервопривода.

В разложенном виде лампа создает Очень большую нагрузку на основание, поэтому прямое подключение маломощного сервопривода SG90 невозможно. Чтобы перенести нагрузку с сервопривода, я использую подшипник.

LifeHack: сразу 8 отличных подшипников можно взять от старых роликовых коньков. Нам потребуется только 1.

Собираем такую конструкцию:

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/e222a576-3c8e-4c10-8b9e-de4abc80808d)

LifeHack: металлическая скоба сделана из уголка под штукатурку - это очень дешевый и довольно крепкий материал. Искать как "Угол алюминиевый перфорированный 20x20"

В такой конструкции корпус сервопривода жестко крепится к корпусу лампы и внешней стороне подшипника. Сервопривод вращает внутреннюю сторону подшипника, на которую так же винтом закреплена полка - основание. Важно! В моем примере основание будет иметь дополнительное крепление к столу. Чтобы лампа не заваливалась под собственным весом,потребуется полка не менее 15см.

Подкдлючаем сервопривод к 3 проводам, которые мы вывели раннее. Зеленый (pin для серво) подключаем прямо к хвосту, обрезаем излишек. К красному и черному проводу необходимо врезаться удобным для Вас способом. Останется хвост 50+ см из красного и черного провода - подключаем к источнику питания.

У моего светльника у основания был корпус под дроссель для люминисцентной лампы, поэтому сервопривод я спрятал в корпус. В модификации без этого корпуса, каркас лампы придется сместить влево или вправо и подумать над жестким креплением к внешней стороне подшипника, так как нагрузка рычага лампы большая (про горячий клей и жидкие гвозди забудьте).

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/fc65f969-dae8-4c74-85c5-3db6e61aa41a)

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/ba743656-e7bf-423b-9979-1aa35e68b491)

Сцепку корпуса лампы с внешней стороной подшипника сделал так же из металлического  уголка. Это был уже третий вариант крепления, поэтому корпус много повидал.

![image](https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/54afbb9c-3ed3-4ad5-8ce0-7706672011a3)

На этом этапе корпус лампы собран, все контакты подключены и прозвонены. Осталось только загрузить скетч.

4. Загружаем скетч.
```cpp
#include <Ultrasonic.h>
#include <Servo.h>

//пины
int trigPin = A0;
int echoPin = A1;
int potentiometer = A3;
int LED = 3;    //ШИМ
int LED2 = 6;    //ШИМ
int LED3 = 11;    //ШИМ
int LED4 = 10;    //ШИМ
int LED5 = 9;    //ШИМ
int servoPin = 5;

//переменные
int distance = 0;
int power = 0;       // при включении, диоды выключены
int sleepmode = 0;    // при включении, выходит из сна
int sleepPos = 180;    // позиция сна (в градусах)
int targetPos = 130;    // позиция в режиме работы (в градусах)
int stepPos = 3;    // шаг вращения
int rate = 2;    // погрешность в см, так как датчик работает от 2см
int old_distance = 0;    // для сравнения прошлого и нынешнего показателя
Ultrasonic ultrasonic(trigPin, echoPin);
Servo Servo1;


void setup(){ 
  Serial.begin(9600); // Запускаем монитор для инфо
  pinMode(LED, OUTPUT);
  pinMode(LED2, OUTPUT);
  pinMode(LED3, OUTPUT);
  pinMode(LED4, OUTPUT);
  pinMode(LED5, OUTPUT);
  pinMode(potentiometer, INPUT);
  Servo1.attach(servoPin);
  targetPos = targetPos / stepPos; // меняем градусы на делитель для потенциометра
  Servo1.write(sleepPos); //калибруем на позицию сна
  delay(100);
}

void loop(){
  //задаем дистанцию для управления
  distance = ultrasonic.distanceRead();
  if (distance < (15 + rate) && distance > (0 + rate)) {
    power = (distance - rate) * 17;
    analogWrite(LED, power);
    analogWrite(LED2, power);
    analogWrite(LED3, power);
    analogWrite(LED4, power);
    analogWrite(LED5, power);

  } else if (distance < (1 + rate) && distance > 0) {
    power = 0;
    analogWrite(LED, power);
    analogWrite(LED2, power);
    analogWrite(LED3, power);
    analogWrite(LED4, power);
    analogWrite(LED5, power);

  } else if (distance < (20 + rate) && distance > (16 + rate)) {
    power = 255;
    analogWrite(LED, power);
    analogWrite(LED2, power);
    analogWrite(LED3, power);
    analogWrite(LED4, power);
    analogWrite(LED5, power);

  } else {analogWrite(LED, power);
  analogWrite(LED2, power);
  analogWrite(LED3, power);
  analogWrite(LED4, power);
  analogWrite(LED5, power);}

  //задаем угол вращения
  if (distance != old_distance) {
    int currPos = Servo1.read(); // Текущая позиция
    int val_poten = analogRead(potentiometer); // Считываем данные с потенциометра
    targetPos = map(val_poten, 0, 1023, 0, 180 / stepPos); // переводим данные потенциометра в новый диапазон


  if (power == 0) {    // переход в режим сна
    delay(1000);
    while (currPos < sleepPos) {
      currPos += stepPos;
      if (currPos > sleepPos) {
      currPos = sleepPos; // Если currPos стал больше sleepPos, присваиваем currPos значение sleepPos
      }
      Servo1.write(currPos);
      delay(100);
}

  } else {
    int diff = abs(currPos - (targetPos * stepPos)); // Вычисляем разницу между переменными
    if (diff > 5) { // Если разница больше 5
        if (currPos > (targetPos * stepPos)) { // Если текущая позиция больше заданной
            while (currPos > (targetPos * stepPos)) { // Вращаем сервомотор влево с шагом 5 градусов
                currPos -= stepPos;
                if (currPos < (targetPos * stepPos)) {
                  currPos = targetPos; // Если currPos стал больше sleepPos, присваиваем currPos значение sleepPos
                  }
                Servo1.write(currPos);
                delay(100);
            }
        } else if (currPos < (targetPos * stepPos)) { // Если текущая позиция меньше заданной
            while (currPos < (targetPos * stepPos)) { // Вращаем сервомотор вправо с шагом 5 градусов
                currPos += stepPos;
                if (currPos > (targetPos * stepPos)) {
                  currPos = targetPos; // Если currPos стал больше sleepPos, присваиваем currPos значение sleepPos
                  }
                Servo1.write(currPos);
                delay(100);
            }
        }
    } else {
        // Разница между переменными составляет 5 или менее
    }
}
  }
  old_distance = distance;    //перезаписываем переменную
  
  //Монитор для инфо
  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.print(" cm, power: ");
  Serial.println(power);
  delay(300);

}
```
Справочно. В коде заложено несколько функций, чтобы пощадить сервомотор: 
- плавное перемещение светильника (переменная stepPos)
- будет работать только при изменении показателей ультразвукового датчика (переменная old_distance),
- не будет реагировать на близкий к заданному углу промежуток в 5 градусов (переменная diff)

5. Итоговый результат:

https://github.com/Kirill-Kasparov/Smart-LED-lamp-Arduino/assets/131332065/37e47819-3efb-438b-ace4-131e6abe4a67

Бум! :-)
